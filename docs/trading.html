<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="INVEX Trading: Trade crypto, forex, stocks, and more with real-time charts, order placement, and portfolio management.">
  <meta name="theme-color" content="#101223">
  <meta property="og:title" content="INVEX — Trading">
  <meta property="og:description" content="Trade crypto, forex, stocks, and more with real-time charts and order management.">
  <meta property="og:image" content="assets/favicon-32x32.png">
  <meta property="og:type" content="website">
  <link rel="icon" href="assets/favicon.ico">
  <link rel="apple-touch-icon" href="assets/favicon-32x32.png">
  <link rel="stylesheet" href="styles.css">
  <title>INVEX — Trading</title>
  <style>
    :root {
      --main-bg: linear-gradient(120deg, #101223 60%, #1565ff 100%);
      --card-bg: #181a20;
      --accent: #1565ff;
      --text: #fff;
      --table-header: #232a3b;
      --badge-bg: #232a3b;
    }
    html, body {
      background: var(--main-bg);
      color: var(--text);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 18px;
    }
    h1 {
      font-size: 2.2rem;
      font-weight: 900;
      letter-spacing: 1px;
      margin: 38px 0 18px 0;
      color: var(--text);
      text-shadow: 0 2px 12px #1565ff22;
    }
    .card {
      background: var(--card-bg);
      border-radius: 22px;
      box-shadow: 0 8px 32px 0 #1565ff22;
      padding: 32px 24px 24px 24px;
      margin-bottom: 32px;
      width: 100%;
      transition: background 0.3s;
    }
    .order-form {
      display: flex;
      flex-direction: column;
      gap: 18px;
      background: #232a3b;
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px #1565ff22;
      max-width: 420px;
    }
    .order-form label {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .order-form input, .order-form select {
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1.08rem;
      background: #181a20;
      color: #fff;
      margin-bottom: 8px;
    }
    .order-form button {
      background: #1565ff;
      color: #fff;
      font-size: 1.08rem;
      font-weight: 700;
      padding: 12px 0;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .order-form button:hover {
      background: #1a7fff;
    }
    .orders-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 24px;
      background: none;
    }
    .orders-table th, .orders-table td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #232a3b;
      font-size: 1.05rem;
    }
    .orders-table th {
      background: var(--table-header);
      color: var(--accent);
      font-weight: 700;
      font-size: 1.08rem;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .orders-table tr:last-child td {
      border-bottom: none;
    }
    .orders-table td.right, .orders-table th.right {
      text-align: right;
    }
    .orders-table tr:hover {
      background: #1565ff22;
      cursor: pointer;
      transition: background 0.2s;
    }
    #tv_chart_container {
      width: 100%;
      height: 480px;
      min-height: 320px;
      margin: 32px 0 24px 0;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 2px 12px #1565ff22;
      transition: background 0.3s;
    }
    @media (max-width: 900px) {
      .container { padding: 0 4px; }
      .card { padding: 16px 4px; }
      h1 { font-size: 1.5rem; }
      #tv_chart_container { height: 320px; }
      .orders-table th, .orders-table td { padding: 8px 4px; font-size: 0.98rem; }
      .order-form { padding: 12px; }
    }
  </style>
</head>
<body>
  <nav class="main-nav sticky-nav" aria-label="Main navigation" style="min-height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 32px;position:relative;z-index:20;background:#000;">
    <div style="display:flex;align-items:center;gap:18px;">
      <a id="logoLink" href="index.html" style="font-size:2rem;font-weight:900;letter-spacing:1px;text-decoration:none;display:flex;align-items:center;">
        <span style="color:#1565ff;">in</span><span style="color:#fff;">vex</span>
      </a>
    </div>
    <div style="display:flex;align-items:center;gap:32px;">
      <a href="markets.html" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Markets</a>
      <a href="trading.html" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Trading</a>
      <a href="#" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Education</a>
    </div>
    <div style="display:flex;align-items:center;gap:18px;">
      <span id="userEmail" style="color:#fff;font-size:1.08rem;font-weight:600;display:none;"></span>
      <a id="portfolioBtn" href="portfolio.html" style="display:none;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff22;transition:background 0.2s;">Portfolio</a>
      <a id="authBtn" class="btn" href="login.html" style="background:#232a3b;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff22;transition:background 0.2s;">Log in</a>
      <a id="registerBtn" href="signup.html" style="background:#1565ff;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff33;transition:background 0.2s;">Register</a>
    </div>
  </nav>
  <main id="mainContent">
    <div class="container">
      <h1>Trading</h1>
      <div id="tv_chart_container"></div>
      <div class="card" style="display:flex;flex-wrap:wrap;gap:32px;align-items:flex-start;">
        <form class="order-form" id="orderForm" autocomplete="off">
          <label for="symbol">Symbol</label>
          <select id="symbol" name="symbol" required>
            <option value="BTCUSDT">BTC/USDT</option>
            <option value="ETHUSDT">ETH/USDT</option>
            <option value="BNBUSDT">BNB/USDT</option>
            <option value="ADAUSDT">ADA/USDT</option>
            <option value="SOLUSDT">SOL/USDT</option>
            <option value="XRPUSDT">XRP/USDT</option>
          </select>
          <label for="side">Side</label>
          <select id="side" name="side" required>
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
          </select>
          <label for="amount">Amount</label>
          <input type="number" id="amount" name="amount" min="0.0001" step="0.0001" required>
          <label for="leverage">Leverage</label>
          <input type="number" id="leverage" name="leverage" min="1" max="100" value="1" required>
          <button type="submit">Place Order</button>
        </form>
        <div style="flex:1 1 0;min-width:320px;">
          <h2 style="font-size:1.3rem;font-weight:800;margin-bottom:12px;">Open Orders</h2>
          <table class="orders-table" id="ordersTable">
            <thead>
              <tr><th>Symbol</th><th>Side</th><th>Amount</th><th>Leverage</th><th>Open Price</th><th>Notional</th><th>P&L</th><th>Time</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="demoNotice" style="display:none;margin-top:18px;color:#ffb300;font-weight:700;font-size:1.08rem;">Demo mode: Orders are not real. Log in to trade for real.</div>
    <script>
    // --- Live price fetcher for demo mode ---
    async function fetchDemoPrice(symbol) {
      // Map symbol to CoinGecko id
      const map = {
        BTCUSDT: 'bitcoin', ETHUSDT: 'ethereum', BNBUSDT: 'binancecoin', ADAUSDT: 'cardano', SOLUSDT: 'solana', XRPUSDT: 'ripple'
      };
      const id = map[symbol] || 'bitcoin';
      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`);
        const data = await res.json();
        return data[id]?.usd || 0;
      } catch { return 0; }
    }
    // Format time
    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    // Format number
    function fmt(n, d=2) { return Number(n).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d }); }
    </script>
        </div>
      </div>
    </div>
  </main>
  <footer style="background:#181a20;color:#bbb;text-align:center;padding:24px 0 12px 0;font-size:1.05rem;margin-top:48px;letter-spacing:0.2px;">
    <div style="margin-bottom:8px;">
      <a href="#" style="color:#1565ff;text-decoration:none;font-weight:700;margin:0 12px;">Terms</a>
      <a href="#" style="color:#1565ff;text-decoration:none;font-weight:700;margin:0 12px;">Privacy</a>
      <a href="#" style="color:#1565ff;text-decoration:none;font-weight:700;margin:0 12px;">Contact</a>
    </div>
    <span>© <span id="year"></span> INVEX. All rights reserved.</span>
  </footer>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    // --- TradingView Widget Loader ---
    function loadTradingViewWidget(symbol = 'BTCUSDT', containerId = 'tv_chart_container') {
      const old = document.getElementById(containerId);
      if (old) old.innerHTML = '';
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://s3.tradingview.com/tv.js';
      script.onload = function() {
        new TradingView.widget({
          autosize: true,
          symbol: symbol,
          interval: '1',
          timezone: 'Etc/UTC',
          theme: 'dark',
          style: '1',
          locale: 'en',
          toolbar_bg: '#181a20',
          enable_publishing: false,
          allow_symbol_change: true,
          container_id: containerId
        });
      };
      document.body.appendChild(script);
    }
    // On page load, load default chart
    document.addEventListener('DOMContentLoaded', function() {
      loadTradingViewWidget('BTCUSDT');
      document.getElementById('symbol').addEventListener('change', function() {
        loadTradingViewWidget(this.value);
      });
    });
    // Backend-driven authentication and user info
    async function getCurrentUser() {
      try {
        const res = await fetch('https://invex-public.onrender.com/api/auth/me', { credentials: 'include' });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    // Demo order logic
let demoOrders = [];
async function renderDemoOrders() {
  const ordersTable = document.getElementById('ordersTable').querySelector('tbody');
  if (!demoOrders.length) {
    ordersTable.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#888;">No open orders</td></tr>';
    return;
  }
  // Fetch latest prices for all unique symbols
  const symbols = [...new Set(demoOrders.map(o => o.symbol))];
  const prices = {};
  for (const sym of symbols) {
    prices[sym] = await fetchDemoPrice(sym);
  }
  ordersTable.innerHTML = demoOrders.map(o => {
    const openPrice = o.openPrice || 0;
    const curPrice = prices[o.symbol] || 0;
    const notional = o.amount * openPrice * o.leverage;
    // Simulate P&L: random fluctuation for demo
    let pnl = 0;
    if (openPrice && curPrice) {
      const change = (curPrice - openPrice) / openPrice;
      pnl = (o.side === 'buy' ? change : -change) * notional * (0.95 + Math.random()*0.1); // add some randomness
    }
    return `<tr>
      <td>${o.symbol}</td>
      <td>${o.side}</td>
      <td>${fmt(o.amount, 4)}</td>
      <td>${o.leverage}x</td>
      <td>${openPrice ? fmt(openPrice, 2) : '-'}</td>
      <td>${openPrice ? fmt(notional, 2) : '-'}</td>
      <td style="color:${pnl > 0 ? '#4caf50' : pnl < 0 ? '#f44336' : '#fff'};font-weight:700;">${openPrice ? fmt(pnl, 2) : '-'}</td>
      <td>${o.time ? formatTime(o.time) : '-'}</td>
      <td>Demo</td>
    </tr>`;
  }).join('');
}

    async function renderRealOrders() {
      const ordersTable = document.getElementById('ordersTable').querySelector('tbody');
      try {
        const res = await fetch('https://invex-public.onrender.com/api/orders', { credentials: 'include' });
        if (!res.ok) throw new Error('Not logged in');
        const orders = await res.json();
        ordersTable.innerHTML = (orders && orders.length)
          ? orders.map(o => `<tr><td>${o.symbol}</td><td>${o.side}</td><td>${o.amount}</td><td>${o.leverage}x</td><td>${o.status || 'Open'}</td></tr>`).join('')
          : '<tr><td colspan="5" style="text-align:center;color:#888;">No open orders</td></tr>';
      } catch {
        ordersTable.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">No open orders</td></tr>';
      }
    }

    async function updateAuthUI() {
      const user = await getCurrentUser();
      const authBtn = document.getElementById('authBtn');
      const userEmail = document.getElementById('userEmail');
      const registerBtn = document.getElementById('registerBtn');
      const portfolioBtn = document.getElementById('portfolioBtn');
      const logoLink = document.getElementById('logoLink');
      const demoNotice = document.getElementById('demoNotice');
      if (user && authBtn && userEmail) {
        userEmail.textContent = user.email || '';
        userEmail.style.display = 'inline-block';
        userEmail.onclick = null;
        if (portfolioBtn) {
          portfolioBtn.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'portfolio.html';
          };
        }
        document.querySelectorAll('a[href="markets.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'markets.html';
          };
        });
        document.querySelectorAll('a[href="trading.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'trading.html';
          };
        });
        document.querySelectorAll('a[href="portfolio.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'portfolio.html';
          };
        });
        authBtn.textContent = 'Log out';
        authBtn.href = '#';
        authBtn.onclick = async (e) => {
          e.preventDefault();
          await fetch('https://invex-public.onrender.com/api/users/logout', { method: 'POST', credentials: 'include' });
          location.href = 'index.html';
        }
        if (registerBtn) registerBtn.style.display = 'none';
        if (portfolioBtn) portfolioBtn.style.display = 'inline-block';
        if (logoLink) logoLink.href = 'dashboard.html';
        if (demoNotice) demoNotice.style.display = 'none';
        // Real trading logic
        orderForm.onsubmit = async function(e) {
          e.preventDefault();
          const symbol = orderForm.symbol.value;
          const side = orderForm.side.value;
          const amount = orderForm.amount.value;
          const leverage = orderForm.leverage.value;
          try {
            const res = await fetch('https://invex-public.onrender.com/api/orders', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ symbol, side, amount, leverage })
            });
            if (res.ok) {
              orderForm.reset();
              renderRealOrders();
            } else {
              alert('Order failed: ' + (await res.text()));
            }
          } catch (err) {
            alert('Order failed: ' + err.message);
          }
        };
        renderRealOrders();
      } else {
        if (userEmail) userEmail.style.display = 'none';
        if (registerBtn) registerBtn.style.display = 'inline-block';
        if (portfolioBtn) portfolioBtn.style.display = 'none';
        if (logoLink) logoLink.href = 'index.html';
        if (demoNotice) demoNotice.style.display = 'block';
        // Demo trading logic
        orderForm.onsubmit = function(e) {
          e.preventDefault();
          const symbol = orderForm.symbol.value;
          const side = orderForm.side.value;
          const amount = Number(orderForm.amount.value);
          const leverage = Number(orderForm.leverage.value);
          fetchDemoPrice(symbol).then(openPrice => {
            demoOrders.unshift({ symbol, side, amount, leverage, openPrice, time: Date.now() });
            renderDemoOrders();
            orderForm.reset();
          });
        };
        renderDemoOrders();
      }
    }
    updateAuthUI();
  </script>
</body>
</html>
