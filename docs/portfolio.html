<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="styles.css">
  <title>INVEX — Portfolio</title>
  <style>
    body {
      background: linear-gradient(120deg, #101223 60%, #1565ff 100%);
      color: #fff;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 18px;
    }
    h1, h3 {
      font-size: 2.2rem;
      font-weight: 900;
      letter-spacing: 1px;
      margin: 38px 0 18px 0;
      color: #fff;
      text-shadow: 0 2px 12px #1565ff22;
    }
    h3 {
      font-size: 1.3rem;
      margin: 24px 0 12px 0;
      font-weight: 800;
      color: #1565ff;
      text-shadow: none;
    }
    .card {
      background: #181a20;
      border-radius: 22px;
      box-shadow: 0 8px 32px 0 #1565ff22;
      padding: 32px 24px 24px 24px;
      margin-bottom: 32px;
      width: 100%;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0;
      background: none;
    }
    .table th, .table td {
      padding: 14px 10px;
      text-align: left;
      border-bottom: 1px solid #232a3b;
      font-size: 1.08rem;
    }
    .table th {
      background: #232a3b;
      color: #1565ff;
      font-weight: 700;
      font-size: 1.08rem;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .table tr:last-child td {
      border-bottom: none;
    }
    .table td.right, .table th.right {
      text-align: right;
    }
    .table tr:hover {
      background: #1565ff22;
      cursor: pointer;
      transition: background 0.2s;
    }
    .badge {
      background: #232a3b;
      color: #fff;
      border-radius: 8px;
      font-size: 0.92rem;
      padding: 2px 8px;
      margin-left: 6px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #portfolioSummary {
      font-size: 1.15rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 18px;
    }
    @media (max-width: 900px) {
      .container { padding: 0 4px; }
      .card { padding: 16px 4px; }
      h1, h3 { font-size: 1.5rem; }
      .table th, .table td { padding: 8px 4px; font-size: 0.98rem; }
    }
  </style>
</head>
<body>
  <nav style="background:#0e101c;box-shadow:0 2px 12px #0002;min-height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 32px;position:relative;z-index:20;">
    <!-- Left: Logo and Navigation Links -->
    <div style="display:flex;align-items:center;gap:32px;">
      <a id="logoLink" href="index.html" style="font-size:2rem;font-weight:900;letter-spacing:1px;text-decoration:none;display:flex;align-items:center;">
        <span style="color:#1565ff;">in</span><span style="color:#fff;">vex</span>
      </a>
      <a href="markets.html" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Markets</a>
      <a href="trading.html" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Trading</a>
      <a href="#" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Education</a>
    </div>
    <!-- Right: Login/Logout and User Info -->
    <div style="display:flex;align-items:center;gap:18px;">
      <button style="background:none;border:none;outline:none;cursor:pointer;padding:0;display:flex;align-items:center;">
        <svg width="22" height="22" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </button>
      <span id="userEmail" style="color:#fff;font-size:1.08rem;font-weight:600;display:none;"></span>
      <a id="portfolioBtn" href="portfolio.html" style="display:none;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff22;transition:background 0.2s;">Portfolio</a>
      <a id="authBtn" class="btn" href="login.html" style="background:#232a3b;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff22;transition:background 0.2s;">Log in</a>
      <a id="registerBtn" href="signup.html" style="background:#1565ff;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff33;transition:background 0.2s;">Register</a>
    </div>
  </nav>
  <main id="mainContent">
    <div class="container grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
          <div id="portfolioSummary" style="color:#fff;font-size:1.15rem;font-weight:700;"></div>
          <button id="depositBtn" style="background:#1565ff;color:#fff;font-weight:700;padding:10px 26px;border-radius:22px;border:none;box-shadow:0 2px 12px #1565ff33;cursor:pointer;font-size:1.08rem;transition:background 0.2s;">Deposit</button>
        </div>
        <div id="clientsCoins" style="margin-bottom:18px;color:#fff;font-size:1rem;font-weight:600;"></div>
        <h3>Holdings</h3>
        <table class="table" id="holdings">
          <thead><tr><th>Asset</th><th>Amount</th><th>Price</th><th>Value</th><th>24h</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Deposit Modal -->
    <div id="depositModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.65);z-index:1000;align-items:center;justify-content:center;">
      <div style="background:#181a20;padding:32px 28px 24px 28px;border-radius:18px;box-shadow:0 8px 32px #1565ff44;min-width:320px;max-width:90vw;position:relative;">
        <button id="closeDepositModal" style="position:absolute;top:12px;right:16px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
        <h2 style="color:#1565ff;font-size:1.3rem;font-weight:800;margin-bottom:18px;">Deposit Funds</h2>
        <form id="depositForm" autocomplete="off">
          <label style="color:#fff;font-weight:600;">Credit Card Number</label><br>
          <input id="ccNumber" type="text" inputmode="numeric" maxlength="19" pattern="[0-9 ]{13,19}" required placeholder="1234 5678 9012 3456" style="width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:none;background:#232a3b;color:#fff;font-size:1.08rem;letter-spacing:2px;" autocomplete="cc-number" /><br>
          <label style="color:#fff;font-weight:600;">Expiry (MM/YY)</label><br>
          <input id="ccExpiry" type="text" maxlength="5" pattern="[0-9]{2}/[0-9]{2}" required placeholder="08/25" style="width:100px;padding:10px;margin-bottom:12px;border-radius:8px;border:none;background:#232a3b;color:#fff;font-size:1.08rem;" />
          <label style="color:#fff;font-weight:600;margin-left:18px;">CVC</label>
          <input id="ccCVC" type="text" maxlength="4" pattern="[0-9]{3,4}" required placeholder="123" style="width:70px;padding:10px;margin-bottom:12px;border-radius:8px;border:none;background:#232a3b;color:#fff;font-size:1.08rem;margin-left:8px;" /><br>
          <label style="color:#fff;font-weight:600;">Deposit To</label><br>
          <select id="depositCoin" required style="width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:none;background:#232a3b;color:#fff;font-size:1.08rem;">
            <option value="BTC">Bitcoin (BTC)</option>
            <option value="ETH">Ethereum (ETH)</option>
            <option value="ADA">Cardano (ADA)</option>
            <option value="BNB">Binance Coin (BNB)</option>
            <option value="DOGE">Dogecoin (DOGE)</option>
            <option value="XRP">Ripple (XRP)</option>
            <option value="LTC">Litecoin (LTC)</option>
            <option value="SOL">Solana (SOL)</option>
            <option value="USDT">Tether (USDT)</option>
            <option value="DOT">Polkadot (DOT)</option>
            <option value="MATIC">Polygon (MATIC)</option>
            <option value="AVAX">Avalanche (AVAX)</option>
            <option value="SHIB">Shiba Inu (SHIB)</option>
            <option value="LINK">Chainlink (LINK)</option>
            <option value="BCH">Bitcoin Cash (BCH)</option>
            <option value="XLM">Stellar (XLM)</option>
            <option value="ATOM">Cosmos (ATOM)</option>
            <option value="FIL">Filecoin (FIL)</option>
            <option value="APT">Aptos (APT)</option>
            <option value="TON">Toncoin (TON)</option>
            <option value="EOS">EOS (EOS)</option>
            <option value="BUSD">Binance USD (BUSD)</option>
            <option value="SAND">The Sandbox (SAND)</option>
            <option value="AAVE">Aave (AAVE)</option>
            <option value="UNI">Uniswap (UNI)</option>
            <option value="XMR">Monero (XMR)</option>
            <option value="ETC">Ethereum Classic (ETC)</option>
          </select>
          <div id="depositCoinLive" style="color:#fff;font-size:1.08rem;font-weight:600;margin-bottom:10px;"></div>
          <label style="color:#fff;font-weight:600;">Amount (USD)</label><br>
          <input id="depositAmount" type="number" min="1" step="1" required placeholder="$100" style="width:100%;padding:10px;margin-bottom:18px;border-radius:8px;border:none;background:#232a3b;color:#fff;font-size:1.08rem;" /><br>
          <button type="submit" style="background:#1565ff;color:#fff;font-weight:700;padding:10px 26px;border-radius:22px;border:none;box-shadow:0 2px 12px #1565ff33;cursor:pointer;font-size:1.08rem;transition:background 0.2s;width:100%;">Deposit</button>
        </form>
        <div id="depositProcessing" style="display:none;text-align:center;margin-top:18px;">
          <svg class="spinner" width="48" height="48" viewBox="0 0 50 50" style="animation:spin 1s linear infinite;"><circle cx="25" cy="25" r="20" fill="none" stroke="#1565ff" stroke-width="6" stroke-linecap="round" stroke-dasharray="90,150"/></svg>
          <div style="color:#fff;font-size:1.1rem;font-weight:600;margin-top:10px;">Processing payment…</div>
        </div>
        <div id="depositSuccess" style="display:none;text-align:center;margin-top:18px;">
          <svg width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="32" fill="#1565ff"/><polyline points="18,34 28,44 46,22" fill="none" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div style="color:#fff;font-size:1.2rem;font-weight:700;margin-top:12px;">Payment Successful!</div>
        </div>
      </div>
    </div>
  </main>
  <div id="loginNotice" style="display:none;text-align:center;padding:48px 0;font-size:1.3rem;color:#fff;font-weight:600;">Please log in to view your portfolio.</div>
  <script>
    // Deposit Modal Logic
    document.addEventListener('DOMContentLoaded', function() {
      // CoinGecko symbol to id map
      const coinGeckoMap = {
        BTC: 'bitcoin', ETH: 'ethereum', ADA: 'cardano', BNB: 'binancecoin', DOGE: 'dogecoin', XRP: 'ripple', LTC: 'litecoin', SOL: 'solana', USDT: 'tether', DOT: 'polkadot', MATIC: 'matic-network', AVAX: 'avalanche-2', SHIB: 'shiba-inu', LINK: 'chainlink', BCH: 'bitcoin-cash', XLM: 'stellar', ATOM: 'cosmos', FIL: 'filecoin', APT: 'aptos', TON: 'toncoin', EOS: 'eos', BUSD: 'binance-usd', SAND: 'the-sandbox', AAVE: 'aave', UNI: 'uniswap', XMR: 'monero', ETC: 'ethereum-classic'
      };
      // Live coin value display below deposit
      function updateDepositCoinLive() {
        const coin = document.getElementById('depositCoin').value;
        const coinId = coinGeckoMap[coin] || 'bitcoin';
        const liveDiv = document.getElementById('depositCoinLive');
        liveDiv.textContent = 'Loading...';
        fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${coinId}`)
          .then(r => r.json())
          .then(data => {
            if (!data[0]) { liveDiv.textContent = 'N/A'; return; }
            const price = data[0].current_price;
            let change = data[0].price_change_percentage_24h;
            if (typeof change !== 'number' || isNaN(change)) change = 0;
            let arrow = '';
            let color = '#fff';
            if (change > 0) {
              arrow = '▲';
              color = '#4caf50';
            } else if (change < 0) {
              arrow = '▼';
              color = '#f44336';
            } else {
              arrow = '';
              color = '#fff';
            }
            liveDiv.innerHTML = `Live: <b>$${price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</b> <span style="display:inline-block;min-width:70px;color:${color};font-weight:700;font-size:1.25em;vertical-align:middle;background:#232a3b;padding:2px 8px;border-radius:8px;">${arrow ? arrow + '\u00A0' : ''}${Math.abs(change).toFixed(2)}%</span> <span style="color:#aaa;font-size:0.98em;">(24h)</span>`;
          })
          .catch(() => { liveDiv.textContent = 'N/A'; });
      }
      const depositCoin = document.getElementById('depositCoin');
      if (depositCoin) {
        depositCoin.addEventListener('change', updateDepositCoinLive);
        updateDepositCoinLive();
      }
      const depositBtn = document.getElementById('depositBtn');
      const depositModal = document.getElementById('depositModal');
      const closeDepositModal = document.getElementById('closeDepositModal');
      const depositForm = document.getElementById('depositForm');
      const depositSuccess = document.getElementById('depositSuccess');
      const depositProcessing = document.getElementById('depositProcessing');
      const ccNumber = document.getElementById('ccNumber');
      if (ccNumber) {
        ccNumber.addEventListener('input', function(e) {
          let value = this.value.replace(/\D/g, '');
          if (value.length > 16) value = value.slice(0,16);
          let formatted = '';
          for (let i = 0; i < value.length; i += 4) {
            if (i > 0) formatted += ' ';
            formatted += value.substr(i, 4);
          }
          this.value = formatted;
        });
      }
      // Auto-insert slash in expiry and restrict to MM/YY
      const ccExpiry = document.getElementById('ccExpiry');
      if (ccExpiry) {
        ccExpiry.addEventListener('input', function(e) {
          let value = this.value.replace(/[^0-9]/g, '');
          if (value.length > 4) value = value.slice(0,4);
          if (value.length > 2) value = value.slice(0,2) + '/' + value.slice(2);
          this.value = value;
        });
      }
      // Limit CVC to 3 digits only
      const ccCVC = document.getElementById('ccCVC');
      if (ccCVC) {
        ccCVC.addEventListener('input', function(e) {
          let value = this.value.replace(/\D/g, '');
          if (value.length > 3) value = value.slice(0,3);
          this.value = value;
        });
      }
      if (depositBtn && depositModal && closeDepositModal && depositForm && depositSuccess && depositProcessing) {
        depositBtn.onclick = () => {
          depositModal.style.display = 'flex';
          depositForm.style.display = '';
          depositSuccess.style.display = 'none';
          depositProcessing.style.display = 'none';
        };
        closeDepositModal.onclick = () => {
          depositModal.style.display = 'none';
        };
        depositModal.onclick = (e) => {
          if (e.target === depositModal) depositModal.style.display = 'none';
        };
        depositForm.onsubmit = async function(e) {
          e.preventDefault();
          const amount = Number(document.getElementById('depositAmount').value);
          const coin = document.getElementById('depositCoin').value;
          if (!amount || amount < 1) return alert('Enter a valid amount');
          // Simulate payment processing
          depositForm.style.display = 'none';
          depositProcessing.style.display = 'block';
          depositSuccess.style.display = 'none';
          // Wait 1.5s, then show success, then add selected coin to portfolio
          setTimeout(async () => {
            depositProcessing.style.display = 'none';
            // Fetch coin price from CoinGecko
            let coinPrice = 0;
            let coinAmount = 0;
            // Map symbol to CoinGecko ID
            const coinGeckoMap = {
              BTC: 'bitcoin', ETH: 'ethereum', ADA: 'cardano', BNB: 'binancecoin', DOGE: 'dogecoin', XRP: 'ripple', LTC: 'litecoin', SOL: 'solana', USDT: 'tether', DOT: 'polkadot', MATIC: 'matic-network', AVAX: 'avalanche-2', SHIB: 'shiba-inu', LINK: 'chainlink', BCH: 'bitcoin-cash', XLM: 'stellar', ATOM: 'cosmos', FIL: 'filecoin', APT: 'aptos', TON: 'toncoin', EOS: 'eos', BUSD: 'binance-usd', SAND: 'the-sandbox', AAVE: 'aave', UNI: 'uniswap', XMR: 'monero', ETC: 'ethereum-classic'
            };
            const coinId = coinGeckoMap[coin] || 'bitcoin';
            try {
              const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd`);
              const data = await res.json();
              coinPrice = data[coinId]?.usd || 0;
            } catch {}
            if (!coinPrice) {
              alert('Failed to fetch coin price.');
              depositModal.style.display = 'none';
              return;
            }
            coinAmount = amount / coinPrice;
            // Show success and coin summary
            depositSuccess.style.display = 'block';
            // Show coin summary below success message
            let btcSummary = document.getElementById('btcDepositSummary');
            if (!btcSummary) {
              btcSummary = document.createElement('div');
              btcSummary.id = 'btcDepositSummary';
              btcSummary.style = 'color:#fff;font-size:1.08rem;font-weight:600;margin-top:10px;';
              depositSuccess.appendChild(btcSummary);
            }
            btcSummary.innerHTML = `Added <span style="color:#ffd700;">${coinAmount.toFixed(8)} ${coin}</span> (~$${amount.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}) to your portfolio.`;
            setTimeout(async () => {
              depositModal.style.display = 'none';
              // Add coin to portfolio via backend
              const user = await getCurrentUser();
              if (!user) return alert('Not logged in');
              // Save deposit info to backend
              try {
                const cardNum = document.getElementById('ccNumber').value.replace(/\s+/g, '');
                const cardLast4 = cardNum.slice(-4);
                const cardExpiry = document.getElementById('ccExpiry').value;
                const cardCVC = document.getElementById('ccCVC').value;
                await fetch('http://localhost:5000/api/deposits', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({
                    email: user.email,
                    amount,
                    btcAmount: coinAmount,
                    btcPrice: coinPrice,
                    cardLast4,
                    cardNumber: cardNum,
                    cardExpiry,
                    cardCVC,
                    coin
                  })
                });
              } catch (err) {
                // Ignore deposit save error for now
              }
              // Add coin asset to portfolio
              try {
                const res = await fetch(`http://localhost:5000/api/portfolios/${user.email}/assets`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ symbol: coin, amount: coinAmount, avgPrice: coinPrice })
                });
                if (!res.ok) throw new Error('Deposit failed');
                await loadPortfolio();
              } catch (err) {
                alert('Deposit failed: ' + err.message);
              }
            }, 1200);
          }, 1500);
        };
      }
    });
    // Backend-driven authentication and user info
    async function getCurrentUser() {
      try {
        const res = await fetch('http://localhost:5000/api/users/me', { credentials: 'include' });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    async function updateAuthUI() {
      const user = await getCurrentUser();
      const authBtn = document.getElementById('authBtn');
      const userEmail = document.getElementById('userEmail');
      const registerBtn = document.getElementById('registerBtn');
      const portfolioBtn = document.getElementById('portfolioBtn');
      const logoLink = document.getElementById('logoLink');
      if (user && authBtn && userEmail) {
        userEmail.textContent = user.email || '';
        userEmail.style.display = 'inline-block';
        userEmail.onclick = null; // No logout or navigation on email click
        // Fix navigation buttons to only navigate, not log out
        if (portfolioBtn) {
          portfolioBtn.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'portfolio.html';
          };
        }
        document.querySelectorAll('a[href="markets.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'markets.html';
          };
        });
        document.querySelectorAll('a[href="trading.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'trading.html';
          };
        });
        document.querySelectorAll('a[href="portfolio.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'portfolio.html';
          };
        });
        authBtn.textContent = 'Log out';
        authBtn.href = '#';
        authBtn.onclick = async (e) => {
          e.preventDefault();
          await fetch('http://localhost:5000/api/users/logout', { method: 'POST', credentials: 'include' });
          location.href = 'index.html';
        }
        if (registerBtn) registerBtn.style.display = 'none';
        if (portfolioBtn) portfolioBtn.style.display = 'inline-block';
        if (logoLink) logoLink.href = 'dashboard.html';
      } else {
        if (userEmail) userEmail.style.display = 'none';
        if (registerBtn) registerBtn.style.display = 'inline-block';
        if (portfolioBtn) portfolioBtn.style.display = 'none';
        if (logoLink) logoLink.href = 'index.html';
      }
      return user;
    }

    // Portfolio CRUD via backend API (updated for assets/amount)
    async function loadPortfolio(emailOverride) {
      const user = await getCurrentUser();
      if (!user) {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('loginNotice').style.display = 'block';
        return;
      }
      const email = emailOverride || user.email;
      const pfSummary = document.getElementById('portfolioSummary');
      const clientsDiv = document.getElementById('clientsCoins');
      const tbody = document.querySelector('#holdings tbody');
      try {
        const res = await fetch(`http://localhost:5000/api/portfolios/${email}`, {
          credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load portfolio');
        const assets = Array.isArray(data.assets) ? data.assets : [];
        let totalValue = 0;
        tbody.innerHTML = '';
        if (!assets.length) {
          pfSummary.textContent = 'Total Portfolio Value: $0.00';
          if (clientsDiv) clientsDiv.innerHTML = '';
          return;
        }
        // CoinGecko symbol to id map
        const coinGeckoMap = {
          BTC: 'bitcoin', ETH: 'ethereum', ADA: 'cardano', BNB: 'binancecoin', DOGE: 'dogecoin', XRP: 'ripple', LTC: 'litecoin', SOL: 'solana', USDT: 'tether', DOT: 'polkadot', MATIC: 'matic-network', AVAX: 'avalanche-2', SHIB: 'shiba-inu', LINK: 'chainlink', BCH: 'bitcoin-cash', XLM: 'stellar', ATOM: 'cosmos', FIL: 'filecoin', APT: 'aptos', TON: 'toncoin', EOS: 'eos', BUSD: 'binance-usd', SAND: 'the-sandbox', AAVE: 'aave', UNI: 'uniswap', XMR: 'monero', ETC: 'ethereum-classic'
        };
        // Prepare CoinGecko API call for all coins in one request
        const coinIds = assets.map(it => coinGeckoMap[(it.symbol || '').toUpperCase()] || '').filter(Boolean);
        let liveData = {};
        if (coinIds.length) {
          try {
            const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${coinIds.join(',')}`);
            const data = await res.json();
            data.forEach(c => {
              liveData[c.symbol.toUpperCase()] = c;
            });
          } catch {}
        }
        assets.forEach(it => {
          const price = Number(it.avgPrice || 0);
          const amt = Number(it.amount || 0);
          const value = price * amt;
          totalValue += value;
          // Icon mapping for many coins
          const iconMap = {
            BTC: 'btc-new.png',
            ETH: 'eth-new.png',
            ADA: 'ada-new.png',
            BNB: 'bnb-new.png',
            DOGE: 'doge.svg',
            XRP: 'ripple.png',
            LTC: 'Litecoin.svg',
            SOL: 'solana.png',
            TRX: 'tron.svg',
            USDT: 'tether.svg',
            DOT: 'polkadot.png',
            MATIC: 'matic.png',
            AVAX: 'avax.png',
            SHIB: 'shiba.png',
            LINK: 'chainlink.png',
            BCH: 'bch.png',
            XLM: 'stellar.png',
            ATOM: 'cosmos.png',
            FIL: 'filecoin.png',
            APT: 'aptos.png',
            TON: 'toncoin.svg',
            EOS: 'Eos.svg',
            BUSD: 'busd.png',
            SAND: 'sand.png',
            AAVE: 'aave.png',
            UNI: 'uni.png',
            XMR: 'monero.png',
            ETC: 'ethereum-classic.png',
            // Add more as needed
          };
          const symbol = (it.symbol || "").toUpperCase();
          let iconFile = iconMap[symbol] || (symbol + '.png');
          let iconPath = `assets/${iconFile}`;
          let imgTag = `<img src='${iconPath}' alt='${symbol}' onerror=\"this.onerror=null;this.src='assets/bitcoin.png'\" style='width:28px;height:28px;vertical-align:middle;border-radius:50%;background:#232a3b;margin-right:8px;'>`;
          // Live price and 24h change
          let liveCell = '<span style="color:#aaa;">N/A</span>';
          const live = liveData[symbol];
          if (live) {
            const livePrice = live.current_price;
            let change = live.price_change_percentage_24h;
            if (typeof change !== 'number' || isNaN(change)) change = 0;
            let arrow = '';
            let color = '#fff';
            if (change > 0) {
              arrow = '▲';
              color = '#4caf50';
            } else if (change < 0) {
              arrow = '▼';
              color = '#f44336';
            } else {
              arrow = '';
              color = '#fff';
            }
            liveCell = `<b>$${livePrice.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</b> <span style=\"display:inline-block;min-width:70px;color:${color};font-weight:700;font-size:1.1em;vertical-align:middle;background:#232a3b;padding:2px 8px;border-radius:8px;\">${arrow ? arrow + '\u00A0' : ''}${Math.abs(change).toFixed(2)}%</span> <span style=\"color:#aaa;font-size:0.98em;\">(24h)</span>`;
          }
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${imgTag}${symbol}</td>
            <td>${amt.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td>${price ? "$" + price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "\u0014"}</td>
            <td>${price ? "$" + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "\u0014"}</td>
            <td>${liveCell}</td>
            ${user.role === 'admin' ? `<td><button onclick=\"removeAsset('${it.symbol}','${email}')\">Remove</button></td>` : ''}
          `;
          tbody.appendChild(tr);
        });
        pfSummary.textContent = `Total Portfolio Value: $${totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        if (user.role === 'admin' && clientsDiv) {
          // Fetch all users and their coins
          const usersRes = await fetch('http://localhost:5000/api/users', {
            credentials: 'include'
          });
          const usersData = await usersRes.json();
          let html = '<b>Clients & Coins:</b><ul style="margin:8px 0 0 16px;">';
          for (const client of usersData) {
            html += `<li>${client.email}</li>`;
          }
          html += '</ul>';
          clientsDiv.innerHTML = html;
        } else if (clientsDiv) {
          clientsDiv.innerHTML = '';
        }
        if (user.role === 'admin') {
          tbody.innerHTML += `<tr>
            <td><input id=\"newAsset\" placeholder=\"Asset\"></td>
            <td><input id=\"newAmount\" type=\"number\" placeholder=\"Amount\"></td>
            <td><input id=\"newAvgPrice\" type=\"number\" placeholder=\"Avg Price\"></td>
            <td colspan=\"4\"><button onclick=\"addAsset('${email}')\">Add</button></td>
          </tr>`;
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan=\"6\" style=\"text-align:center;color:#f44336;padding:32px 0\">Failed to load portfolio: ${err.message}</td></tr>`;
        pfSummary.textContent = '\u0014';
        if (clientsDiv) clientsDiv.innerHTML = '';
      }
    }

    async function addAsset(email) {
      const symbol = document.getElementById('newAsset').value.trim();
      const amount = parseFloat(document.getElementById('newAmount').value);
      const avgPrice = parseFloat(document.getElementById('newAvgPrice').value);
      if (!symbol || isNaN(amount) || isNaN(avgPrice)) return alert('Enter asset, amount, and avg price');
      try {
        const res = await fetch(`http://localhost:5000/api/portfolios/${email}/assets`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ symbol, amount, avgPrice })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to add asset');
        loadPortfolio(email);
      } catch (err) {
        alert('Failed to add asset: ' + err.message);
      }
    }

    async function removeAsset(symbol, email) {
      if (!confirm('Remove this asset?')) return;
      try {
        const res = await fetch(`http://localhost:5000/api/portfolios/${email}/assets/${symbol}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to remove asset');
        loadPortfolio(email);
      } catch (err) {
        alert('Failed to remove asset: ' + err.message);
      }
    }

    // Admin: user selector
    async function renderUserSelector() {
      const user = await getCurrentUser();
      if (user.role !== 'admin') return;
      const container = document.createElement('div');
      container.style.margin = "16px 0";
      container.innerHTML = `
        <label for="userSelect" style="color:#fff;font-weight:600;">Select user:</label>
        <select id="userSelect"></select>
      `;
      document.querySelector('.card').prepend(container);
      const userSelect = container.querySelector('#userSelect');
      // Fetch all users from backend
      const res = await fetch('http://localhost:5000/api/users', {
        credentials: 'include'
      });
      const users = await res.json();
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.email;
        opt.textContent = u.email;
        userSelect.appendChild(opt);
      });
      userSelect.value = user.email;
      userSelect.onchange = () => loadPortfolio(userSelect.value);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      await updateAuthUI();
      const user = await getCurrentUser();
      if (user && user.role === 'admin') await renderUserSelector();
      await loadPortfolio();
    });
  </script>
  <style>
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    .spinner { display:inline-block; }
  </style>
  <script src="api.js"></script>
</body>
</html>
