<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="styles.css">
  <title>INVEX — Dashboard</title>
</head>
<body>
  <nav class="main-nav" style="min-height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 32px;position:relative;z-index:20;background:#000;">
    <!-- Left: Logo -->
    <div style="display:flex;align-items:center;gap:18px;">
      <a id="logoLink" href="index.html" style="font-size:2rem;font-weight:900;letter-spacing:1px;text-decoration:none;display:flex;align-items:center;">
        <span style="color:#1565ff;">in</span><span style="color:#fff;">vex</span>
      </a>
    </div>
    <!-- Center: Navigation Links -->
    <div style="display:flex;align-items:center;gap:32px;">
      <a href="markets.html" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Markets</a>
      <a href="trading.html" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Trading</a>
      <a href="#" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Education</a>
    </div>
    <!-- Right: Portfolio/Login -->
    <div style="display:flex;align-items:center;gap:18px;">
      <span id="userEmail" style="color:#fff;font-size:1.08rem;font-weight:600;display:none;cursor:pointer;"></span>
      <a id="portfolioBtn" href="portfolio.html" style="display:none;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff22;transition:background 0.2s;">Portfolio</a>
      <a id="authBtn" class="btn" href="login.html" style="background:#232a3b;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff22;transition:background 0.2s;">Log in</a>
      <a id="registerBtn" href="signup.html" style="background:#1565ff;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff33;transition:background 0.2s;">Register</a>
      <button id="logoutBtn" style="display:none;background:#232a3b;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;border:none;box-shadow:0 2px 12px #1565ff22;cursor:pointer;transition:background 0.2s;">Log out</button>
    </div>
  </nav>
  <script>
  // Backend-driven authentication and user info
  async function getCurrentUser() {
    try {
      const res = await fetch('https://invex-public.onrender.com/api/auth/me', { credentials: 'include' });
      if (!res.ok) return null;
      return await res.json();
    } catch {
      return null;
    }
  }

  async function updateAuthUI() {
    const user = await getCurrentUser();
    const authBtn = document.getElementById('authBtn');
    const userEmail = document.getElementById('userEmail');
    const registerBtn = document.getElementById('registerBtn');
    const portfolioBtn = document.getElementById('portfolioBtn');
    const logoLink = document.getElementById('logoLink');
    const logoutBtn = document.getElementById('logoutBtn');
    if (user && authBtn && userEmail) {
      userEmail.textContent = user.email || '';
      userEmail.style.display = 'inline-block';
      userEmail.onclick = null;
      if (portfolioBtn) {
        portfolioBtn.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'portfolio.html';
        };
      }
      document.querySelectorAll('a[href="markets.html"]').forEach(a => {
        a.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'markets.html';
        };
      });
      document.querySelectorAll('a[href="trading.html"]').forEach(a => {
        a.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'trading.html';
        };
      });
      document.querySelectorAll('a[href="portfolio.html"]').forEach(a => {
        a.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'portfolio.html';
        };
      });
      document.querySelectorAll('a.ghost[href="markets.html"]').forEach(a => {
        a.onclick = (e) => {
          e.preventDefault();
          window.location.href = 'markets.html';
        };
      });
      authBtn.textContent = 'Log out';
      authBtn.href = '#';
      authBtn.onclick = async (e) => {
        e.preventDefault();
        await fetch('https://invex-public.onrender.com/api/users/logout', { method: 'POST', credentials: 'include' });
        location.href = 'index.html';
      }
      if (registerBtn) registerBtn.style.display = 'none';
      if (portfolioBtn) portfolioBtn.style.display = 'inline-block';
      if (logoLink) logoLink.href = 'dashboard.html';
      // Hide login/register on dashboard if logged in
      if (authBtn) authBtn.style.display = 'none';
      if (registerBtn) registerBtn.style.display = 'none';
      if (logoutBtn) {
        logoutBtn.style.display = 'inline-block';
        logoutBtn.onclick = async (e) => {
          e.preventDefault();
          await fetch('https://invex-public.onrender.com/api/users/logout', { method: 'POST', credentials: 'include' });
          location.href = 'index.html';
        };
      }
    } else {
      if (userEmail) userEmail.style.display = 'none';
      if (userEmail) userEmail.onclick = null;
      if (registerBtn) registerBtn.style.display = 'inline-block';
      if (portfolioBtn) portfolioBtn.style.display = 'none';
      if (logoLink) logoLink.href = 'index.html';
      if (authBtn) authBtn.style.display = 'inline-block';
      if (registerBtn) registerBtn.style.display = 'inline-block';
      if (logoutBtn) logoutBtn.style.display = 'none';
    }
    return user;
  }

  // Fetch portfolio from backend API and display assets (using assets/amount fields)
  async function loadPortfolio(showNotification = false) {
    const pfValue = document.getElementById('pfValue');
    const pfChange = document.getElementById('pfChange');
    const assetsTable = document.getElementById('assetsTable').querySelector('tbody');
    const mainContent = document.getElementById('mainContent');
    const loginNotice = document.getElementById('loginNotice');
    const user = await updateAuthUI();
    if (!user) {
      if (mainContent) mainContent.style.display = 'none';
      if (loginNotice) loginNotice.style.display = 'block';
      return;
    }
    if (mainContent) mainContent.style.display = '';
    if (loginNotice) loginNotice.style.display = 'none';
    try {
      const res = await fetch(`https://invex-public.onrender.com/api/portfolios/${user.email}`, {
        credentials: 'include'
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to load portfolio');
      const assets = Array.isArray(data.assets) ? data.assets : [];
      let total = 0;
      assetsTable.innerHTML = '';
      if (!assets.length) {
        assetsTable.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:24px 0;color:#aaa">No holdings yet. Add some from your app.</td></tr>`;
        pfValue.textContent = "$0.00";
        pfChange.textContent = "—";
        return;
      }
      // CoinGecko symbol to id map
      const coinGeckoMap = {
        BTC: 'bitcoin', ETH: 'ethereum', ADA: 'cardano', BNB: 'binancecoin', DOGE: 'dogecoin', XRP: 'ripple', LTC: 'litecoin', SOL: 'solana', USDT: 'tether', DOT: 'polkadot', MATIC: 'matic-network', AVAX: 'avalanche-2', SHIB: 'shiba-inu', LINK: 'chainlink', BCH: 'bitcoin-cash', XLM: 'stellar', ATOM: 'cosmos', FIL: 'filecoin', APT: 'aptos', TON: 'toncoin', EOS: 'eos', BUSD: 'binance-usd', SAND: 'the-sandbox', AAVE: 'aave', UNI: 'uniswap', XMR: 'monero', ETC: 'ethereum-classic'
      };
      // Prepare CoinGecko API call for all coins in one request
      const coinIds = assets.map(it => coinGeckoMap[(it.symbol || '').toUpperCase()] || '').filter(Boolean);
      let liveData = {};
      if (coinIds.length) {
        try {
          const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${coinIds.join(',')}`);
          const data = await res.json();
          data.forEach(c => {
            liveData[c.symbol.toUpperCase()] = c;
          });
        } catch {}
      }
      assets.forEach(it => {
        const price = Number(it.avgPrice || 0);
        const amt = Number(it.amount || 0);
        const value = price * amt;
        total += value;
        // Icon mapping for many coins
        const iconMap = {
          BTC: 'btc-new.png',
          ETH: 'eth-new.png',
          ADA: 'ada-new.png',
          BNB: 'bnb-new.png',
          DOGE: 'doge.svg',
          XRP: 'ripple.png',
          LTC: 'Litecoin.svg',
          SOL: 'solana.png',
          TRX: 'tron.svg',
          USDT: 'tether.svg',
          DOT: 'polkadot.png',
          MATIC: 'matic.png',
          AVAX: 'avax.png',
          SHIB: 'shiba.png',
          LINK: 'chainlink.png',
          BCH: 'bch.png',
          XLM: 'stellar.png',
          ATOM: 'cosmos.png',
          FIL: 'filecoin.png',
          APT: 'aptos.png',
          TON: 'toncoin.svg',
          EOS: 'Eos.svg',
          BUSD: 'busd.png',
          SAND: 'sand.png',
          AAVE: 'aave.png',
          UNI: 'uni.png',
          XMR: 'monero.png',
          ETC: 'ethereum-classic.png',
          // Add more as needed
        };
        const symbol = (it.symbol || "").toUpperCase();
        let iconFile = iconMap[symbol] || (symbol + '.png');
        let iconPath = `assets/${iconFile}`;
        let imgTag = `<img src='${iconPath}' alt='${symbol}' onerror=\"this.onerror=null;this.src='assets/bitcoin.png'\" style='width:28px;height:28px;vertical-align:middle;border-radius:50%;background:#232a3b;margin-right:8px;'>`;
        // Live price and 24h change
        let liveCell = '<span style="color:#aaa;">N/A</span>';
        const live = liveData[symbol];
        if (live) {
          const livePrice = live.current_price;
          let change = live.price_change_percentage_24h;
          if (typeof change !== 'number' || isNaN(change)) change = 0;
          let arrow = '';
          let color = '#fff';
          if (change > 0) {
            arrow = '▲';
            color = '#4caf50';
          } else if (change < 0) {
            arrow = '▼';
            color = '#f44336';
          } else {
            arrow = '';
            color = '#fff';
          }
          liveCell = `<b>$${livePrice.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</b> <span style=\"display:inline-block;min-width:70px;color:${color};font-weight:700;font-size:1.1em;vertical-align:middle;background:#232a3b;padding:2px 8px;border-radius:8px;\">${arrow ? arrow + '\u00A0' : ''}${Math.abs(change).toFixed(2)}%</span> <span style=\"color:#aaa;font-size:0.98em;\">(24h)</span>`;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${imgTag}${symbol}</td>
          <td>${amt.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td>${price ? "$" + price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "—"}</td>
          <td>${price ? "$" + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "—"}</td>
          <td>${liveCell}</td>
        `;
        assetsTable.appendChild(tr);
      });
      pfValue.textContent = "$" + total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      pfChange.textContent = "Change % requires live prices. (We can add next.)";
    } catch (err) {
      assetsTable.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#f44336;padding:32px 0">Failed to load portfolio: ${err.message}</td></tr>`;
      pfValue.textContent = "—";
      pfChange.textContent = "—";
    }
  }

  // Poll for changes every 10 seconds
  setInterval(() => {
    loadPortfolio(true);
  }, 10000);
  window.addEventListener('DOMContentLoaded', () => loadPortfolio());
  </script>
  <main id="mainContent">
    <div class="container grid grid-2">
      <div class="card">
        <h3>Portfolio Value</h3>
        <div id="pfValue" style="font-size:32px;margin-top:8px">—</div>
        <div id="pfChange" class="notice">Loading…</div>
      </div>
      <div class="card">
        <h3>Quick Links</h3>
        <div class="actions" style="margin-top:8px">
          <a class="btn" href="portfolio.html">View Portfolio</a>
          <a class="btn ghost" href="markets.html">Browse Markets</a>
        </div>
      </div>
      <div class="card" style="grid-column:1/-1">
        <h3>Your Assets</h3>
        <table class="table" id="assetsTable">
          <thead>
            <tr><th>Asset</th><th>Amount</th><th>Price</th><th>Value</th><th>24h</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>
  <div id="loginNotice" style="display:none;text-align:center;padding:48px 0;font-size:1.3rem;color:#fff;font-weight:600;">Please log in to view your dashboard.</div>
  <footer>
    © <span id="year"></span> INVEX. Demo UI. Prices from CoinGecko.
  </footer>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
  <script src="scripts/ticker.js"></script>
  <style>
    .card {
      box-shadow: 0 8px 32px 0 #1565ff22;
      background: #181a20;
      border-radius: 22px;
      color: #fff;
    }
    html, body {
      background: #000 !important;
      color: #fff !important;
      overflow-x: hidden !important;
    }
    .container.grid.grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 24px;
      box-sizing: border-box;
      width: 100%;
    }
    @media (max-width: 900px) {
      .container.grid.grid-2 {
        display: flex !important;
        flex-direction: column !important;
      }
    }
  </style>
</body>
</html>
<!-- No code change needed here. The user stays logged in as long as localStorage['invex_user'] is not removed. If portfolio.html logs out the user, remove that logic from portfolio.html. -->
