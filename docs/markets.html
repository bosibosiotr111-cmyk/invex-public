<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="INVEX Markets: Live crypto prices, charts, and portfolio management. Secure, modern, and responsive.">
  <meta name="theme-color" content="#101223">
  <meta property="og:title" content="INVEX â€” Markets">
  <meta property="og:description" content="Live crypto prices, charts, and portfolio management.">
  <meta property="og:image" content="assets/favicon-32x32.png">
  <meta property="og:type" content="website">
  <link rel="icon" href="assets/favicon.ico">
  <link rel="apple-touch-icon" href="assets/favicon-32x32.png">
  <link rel="stylesheet" href="styles.css">
  <title>INVEX â€” Markets</title>
  <style>
    :root {
      --main-bg: linear-gradient(120deg, #101223 60%, #1565ff 100%);
      --card-bg: #181a20;
      --accent: #1565ff;
      --text: #fff;
      --table-header: #232a3b;
      --badge-bg: #232a3b;
    }
    [data-theme="light"] {
      --main-bg: linear-gradient(120deg, #f5f7fa 60%, #c3dafe 100%);
      --card-bg: #fff;
      --accent: #1565ff;
      --text: #181a20;
      --table-header: #e3e8f0;
      --badge-bg: #e3e8f0;
    }
    html, body {
      background: var(--main-bg);
      color: var(--text);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 18px;
    }
    h1 {
      font-size: 2.2rem;
      font-weight: 900;
      letter-spacing: 1px;
      margin: 38px 0 18px 0;
      color: var(--text);
      text-shadow: 0 2px 12px #1565ff22;
    }
    .card {
      background: var(--card-bg);
      border-radius: 22px;
      box-shadow: 0 8px 32px 0 #1565ff22;
      padding: 32px 24px 24px 24px;
      margin-bottom: 32px;
      width: 100%;
      transition: background 0.3s;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0;
      background: none;
    }
    .table th, .table td {
      padding: 14px 10px;
      text-align: left;
      border-bottom: 1px solid #232a3b;
      font-size: 1.08rem;
    }
    .table th {
      background: var(--table-header);
      color: var(--accent);
      font-weight: 700;
      font-size: 1.08rem;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .table tr:last-child td {
      border-bottom: none;
    }
    .table td.right, .table th.right {
      text-align: right;
    }
    .table tr:hover {
      background: #1565ff22;
      cursor: pointer;
      transition: background 0.2s;
    }
    .badge {
      background: var(--badge-bg);
      color: var(--text);
      border-radius: 8px;
      font-size: 0.92rem;
      padding: 2px 8px;
      margin-left: 6px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #tv_chart_container {
      width: 100%;
      height: 480px;
      min-height: 320px;
      margin: 32px 0 24px 0;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 2px 12px #1565ff22;
      transition: background 0.3s;
    }
    .sticky-nav {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #000;
      box-shadow: 0 2px 12px #0002;
    }
    .theme-toggle {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 1.3rem;
      margin-left: 12px;
      cursor: pointer;
      transition: color 0.2s;
    }
    .theme-toggle:hover {
      color: #fff;
    }
    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      background: #232a3b;
      color: #fff;
      padding: 16px 32px;
      border-radius: 16px;
      font-size: 1.08rem;
      font-weight: 600;
      box-shadow: 0 2px 12px #1565ff22;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 9999;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }
    .spinner {
      border: 4px solid #222;
      border-top: 4px solid #4da3ff;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
      display: block;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    @media (max-width: 900px) {
      .container { padding: 0 4px; }
      .card { padding: 16px 4px; }
      h1 { font-size: 1.5rem; }
      #tv_chart_container { height: 320px; }
      .table th, .table td { padding: 8px 4px; font-size: 0.98rem; }
    }
  </style>
</head>
<body>
  <nav class="main-nav sticky-nav" aria-label="Main navigation" style="min-height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 32px;position:relative;z-index:20;background:#000;">
    <!-- Left: Logo -->
    <div style="display:flex;align-items:center;gap:18px;">
      <a id="logoLink" href="index.html" style="font-size:2rem;font-weight:900;letter-spacing:1px;text-decoration:none;display:flex;align-items:center;">
        <span style="color:#1565ff;">in</span><span style="color:#fff;">vex</span>
      </a>
    </div>
    <!-- Center: Navigation Links -->
    <div style="display:flex;align-items:center;gap:32px;">
      <a href="markets.html" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Markets</a>
      <a href="trading.html" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Trading</a>
      <a href="#" style="color:#fff;font-size:1.08rem;font-weight:600;text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;">Education</a>
    </div>
    <!-- Right: Auth and Portfolio -->
    <div style="display:flex;align-items:center;gap:18px;">
      <span id="userEmail" style="color:#fff;font-size:1.08rem;font-weight:600;display:none;"></span>
      <a id="portfolioBtn" href="portfolio.html" style="display:none;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff22;transition:background 0.2s;">Portfolio</a>
      <a id="authBtn" class="btn" href="login.html" style="background:#232a3b;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff22;transition:background 0.2s;">Log in</a>
      <a id="registerBtn" href="signup.html" style="background:#1565ff;color:#fff;font-size:1.08rem;font-weight:700;padding:10px 26px;border-radius:22px;text-decoration:none;box-shadow:0 2px 12px #1565ff33;transition:background 0.2s;">Register</a>
      <button class="theme-toggle" aria-label="Toggle dark/light mode" title="Toggle theme" onclick="toggleTheme()">ðŸŒ“</button>
    </div>
  </nav>
  <main id="mainContent">
    <div class="container">
      <h1>Markets</h1>
      <div id="tv_chart_container"></div>
      <div class="card">
        <table class="table" id="marketTable">
          <thead>
            <tr><th>#</th><th>Name</th><th class="right">Price</th><th class="right">24h</th><th class="right">Market Cap Rank</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>
  <div id="loginNotice" style="display:none;text-align:center;padding:48px 0;font-size:1.3rem;color:#fff;font-weight:600;">Please log in to view market data.</div>
  <footer style="background:#181a20;color:#bbb;text-align:center;padding:24px 0 12px 0;font-size:1.05rem;margin-top:48px;letter-spacing:0.2px;">
    <div style="margin-bottom:8px;">
      <a href="#" style="color:#1565ff;text-decoration:none;font-weight:700;margin:0 12px;">Terms</a>
      <a href="#" style="color:#1565ff;text-decoration:none;font-weight:700;margin:0 12px;">Privacy</a>
      <a href="#" style="color:#1565ff;text-decoration:none;font-weight:700;margin:0 12px;">Contact</a>
    </div>
    <span>Â© <span id="year"></span> INVEX. All rights reserved.</span>
  </footer>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const isLight = html.getAttribute('data-theme') === 'light';
      html.setAttribute('data-theme', isLight ? 'dark' : 'light');
      localStorage.setItem('theme', isLight ? 'dark' : 'light');
      showToast('Switched to ' + (isLight ? 'dark' : 'light') + ' mode');
    }
    // Load theme from storage
    (function(){
      const theme = localStorage.getItem('theme');
      if (theme) document.documentElement.setAttribute('data-theme', theme);
    })();
    // Toast notification
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 2500);
    }
  </script>
  <script src="scripts/markets.js"></script>
  <script>
    // --- TradingView Widget Loader ---
    function loadTradingViewWidget(symbol = 'BTCUSDT', containerId = 'tv_chart_container') {
      const old = document.getElementById(containerId);
      if (old) old.innerHTML = '';
      // TradingView widget script
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://s3.tradingview.com/tv.js';
      script.onload = function() {
        new TradingView.widget({
          autosize: true,
          symbol: symbol,
          interval: '1',
          timezone: 'Etc/UTC',
          theme: 'dark',
          style: '1',
          locale: 'en',
          toolbar_bg: '#181a20',
          enable_publishing: false,
          allow_symbol_change: true,
          container_id: containerId
        });
      };
      document.body.appendChild(script);
    }
    // On page load, load default chart
    document.addEventListener('DOMContentLoaded', function() {
      loadTradingViewWidget('BTCUSDT');
      // Add click event to market table rows after data loads
      const observer = new MutationObserver(() => {
        const table = document.getElementById('marketTable');
        if (!table) return;
        Array.from(table.querySelectorAll('tbody tr')).forEach(row => {
          row.onclick = function() {
            // Try to get symbol from row (e.g., BTC, ETH)
            const nameCell = row.querySelector('td:nth-child(2)');
            if (!nameCell) return;
            const match = nameCell.textContent.match(/\(([^)]+)\)/);
            let symbol = match ? match[1].toUpperCase() : 'BTC';
            // Use TradingView symbol format (e.g., BTCUSDT)
            let tvSymbol = symbol + 'USDT';
            loadTradingViewWidget(tvSymbol);
          };
        });
      });
      observer.observe(document.getElementById('marketTable').querySelector('tbody'), { childList: true });
    });
  </script>
  <script>
    // Backend-driven authentication and user info
    async function getCurrentUser() {
      try {
        const res = await fetch('https://invex-public.onrender.com/api/users/me', { credentials: 'include' });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    async function updateAuthUI() {
      const user = await getCurrentUser();
      const authBtn = document.getElementById('authBtn');
      const userEmail = document.getElementById('userEmail');
      const registerBtn = document.getElementById('registerBtn');
      const portfolioBtn = document.getElementById('portfolioBtn');
      const logoLink = document.getElementById('logoLink');
      if (user && authBtn && userEmail) {
        userEmail.textContent = user.email || '';
        userEmail.style.display = 'inline-block';
        userEmail.onclick = null; // No logout or navigation on email click
        // Fix navigation buttons to only navigate, not log out
        if (portfolioBtn) {
          portfolioBtn.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'portfolio.html';
          };
        }
        document.querySelectorAll('a[href="markets.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'markets.html';
          };
        });
        document.querySelectorAll('a[href="trading.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'trading.html';
          };
        });
        document.querySelectorAll('a[href="portfolio.html"]').forEach(a => {
          a.onclick = (e) => {
            e.preventDefault();
            window.location.href = 'portfolio.html';
          };
        });
        authBtn.textContent = 'Log out';
        authBtn.href = '#';
        authBtn.onclick = async (e) => {
          e.preventDefault();
          await fetch('https://invex-public.onrender.com/api/users/logout', { method: 'POST', credentials: 'include' });
          location.href = 'index.html';
        }
        if (registerBtn) registerBtn.style.display = 'none';
        if (portfolioBtn) portfolioBtn.style.display = 'inline-block';
        if (logoLink) logoLink.href = 'dashboard.html';
      } else {
        if (userEmail) userEmail.style.display = 'none';
        if (registerBtn) registerBtn.style.display = 'inline-block';
        if (portfolioBtn) portfolioBtn.style.display = 'none';
        if (logoLink) logoLink.href = 'index.html';
      }
    }

    updateAuthUI();
  </script>
</body>
</html>
