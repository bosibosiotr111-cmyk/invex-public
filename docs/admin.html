<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>INVEX — Admin Panel</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      background: linear-gradient(120deg, #101223 60%, #1565ff 100%);
      color: #fff;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    }
    .card {
      background: #181a20;
      border-radius: 22px;
      box-shadow: 0 8px 32px 0 #1565ff22;
      padding: 40px 32px 32px 32px;
      margin: 48px auto 32px auto;
      max-width: 520px;
      width: 100%;
    }
    h2, h3 {
      font-weight: 900;
      letter-spacing: 1px;
      margin-bottom: 18px;
    }
    label {
      margin-bottom: 8px;
      display: block;
    }
    select, input {
      background: #232a3b;
      color: #fff;
      border: 1.5px solid #232a3b;
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 1.08rem;
      margin-bottom: 8px;
      outline: none;
      transition: border 0.2s;
    }
    select:focus, input:focus {
      border-color: #1565ff;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 18px;
    }
    .table th, .table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #232a3b;
    }
    .table th {
      background: #232a3b;
      color: #1565ff;
      font-weight: 700;
      font-size: 1.05rem;
    }
    .table tr:last-child td {
      border-bottom: none;
    }
    .btn, button {
      background: #1565ff;
      color: #fff;
      font-size: 1.08rem;
      font-weight: 700;
      padding: 10px 26px;
      border-radius: 22px;
      border: none;
      box-shadow: 0 2px 12px #1565ff22;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      margin-right: 8px;
    }
    button.edit-btn {
      background: #232a3b;
      color: #1565ff;
      font-weight: 700;
      border-radius: 14px;
      padding: 8px 18px;
      box-shadow: 0 2px 12px #1565ff22;
      border: 1.5px solid #1565ff;
      margin-right: 0;
      font-size: 1rem;
    }
    button.edit-btn:hover {
      background: #1565ff;
      color: #fff;
    }
    @media (max-width: 600px) {
      .card { padding: 18px 8px; }
      .table th, .table td { padding: 8px 4px; }
      .btn, button { padding: 8px 12px; font-size: 1rem; }
    }
  </style>
</head>
<body style="background:#101223;">
  <nav style="background:#0e101c;box-shadow:0 2px 12px #0002;min-height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 32px;">
    <a href="#" id="adminLogo" style="font-size:2rem;font-weight:900;letter-spacing:1px;text-decoration:none;display:flex;align-items:center;cursor:default;">
      <span style="color:#1565ff;">in</span><span style="color:#fff;">vex</span>
    </a>
    <span style="color:#fff;font-size:1.15rem;font-weight:700;">Admin Panel</span>
  </nav>
  <script>
    // Prevent navigation for INVEX logo in admin panel
    document.addEventListener('DOMContentLoaded', function() {
      var logo = document.getElementById('adminLogo');
      if (logo) logo.addEventListener('click', function(e) { e.preventDefault(); });
    });
  </script>
  <main>
    <div id="currentClientInfo" style="background:#232a3b;color:#fff;padding:12px 18px;border-radius:12px;margin:24px auto 0 auto;max-width:520px;width:100%;font-size:1.08rem;font-weight:600;box-shadow:0 2px 12px #1565ff22;display:none;"></div>
    <div class="container grid">
      <div class="card client-panel" style="margin-bottom:24px;">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px;">
          <div style="background:#1565ff22;border-radius:50%;width:48px;height:48px;display:flex;align-items:center;justify-content:center;">
            <svg width="28" height="28" fill="#1565ff" viewBox="0 0 24 24"><path d="M12 12c2.7 0 4.5-1.8 4.5-4.5S14.7 3 12 3 7.5 4.8 7.5 7.5 9.3 12 12 12zm0 2c-3 0-9 1.5-9 4.5V21h18v-2.5c0-3-6-4.5-9-4.5z"/></svg>
          </div>
          <div>
            <h2 style="margin:0;font-size:1.45rem;font-weight:900;letter-spacing:1px;color:#1565ff;">Client Management</h2>
            <div style="color:#bbb;font-size:1rem;font-weight:500;">View and manage registered users</div>
          </div>
        </div>
        <div style="color:#1565ff;font-weight:700;font-size:1.08rem;margin-bottom:6px;">Select Client:</div>
        <div id="clientList" style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:18px;"></div>
        <div id="userInfo" class="user-info-card" style="background:#232a3b;padding:18px 16px 18px 16px;border-radius:18px;margin-bottom:18px;color:#fff;display:flex;align-items:center;gap:18px;box-shadow:0 2px 12px #1565ff22;"></div>
      </div>
      <div class="card">
        <h3 style="margin-bottom:8px;">Portfolio Holdings</h3>
        <div id="portfolioSummary" style="margin-bottom:18px;color:#fff;font-size:1.15rem;font-weight:700;"></div>
        <table class="table" id="holdings">
          <thead><tr><th>Asset</th><th>Amount</th><th>Price</th><th>Value</th><th>Edit</th></tr></thead>
          <tbody></tbody>
        </table>
        <h3 style="margin-bottom:8px;">Add Asset</h3>
        <div id="coinSelector" style="display:flex;gap:18px;margin-bottom:12px;">
          <img src="assets/btc-new.png" alt="BTC" title="BTC" class="coin-logo" data-symbol="BTC" style="width:38px;height:38px;cursor:pointer;border:2px solid #232a3b;border-radius:50%;transition:border 0.2s;">
          <img src="assets/eth-new.png" alt="ETH" title="ETH" class="coin-logo" data-symbol="ETH" style="width:38px;height:38px;cursor:pointer;border:2px solid #232a3b;border-radius:50%;transition:border 0.2s;">
          <img src="assets/ada-new.png" alt="ADA" title="ADA" class="coin-logo" data-symbol="ADA" style="width:38px;height:38px;cursor:pointer;border:2px solid #232a3b;border-radius:50%;transition:border 0.2s;">
          <img src="assets/bnb-new.png" alt="BNB" title="BNB" class="coin-logo" data-symbol="BNB" style="width:38px;height:38px;cursor:pointer;border:2px solid #232a3b;border-radius:50%;transition:border 0.2s;">
        </div>
        <input id="newAsset" placeholder="Asset" style="margin-right:8px;display:none;">
        <div id="selectedCoinLabel" style="margin-bottom:8px;color:#1565ff;font-weight:700;font-size:1.08rem;"></div>
        <input id="newAmount" type="number" placeholder="Amount" style="margin-right:8px;">
        <input id="newAvgPrice" type="number" placeholder="Avg Price" style="margin-right:8px;">
        <button onclick="addAsset()">Add</button>
      </div>
    </div>
    <!-- Deposits Table -->
    <div class="container" style="max-width:900px;margin:0 auto;">
      <div class="card" style="margin-top:32px;">
        <h3 style="color:#1565ff;font-size:1.3rem;font-weight:900;margin-bottom:18px;">All Deposits</h3>
        <div id="depositsNotice" class="notice">Loading…</div>
        <table id="depositsTable" style="display:none;width:100%;border-collapse:collapse;background:#181a20;border-radius:18px;overflow:hidden;">
          <thead>
            <tr><th>Email</th><th>Amount (USD)</th><th>BTC Amount</th><th>BTC Price</th><th>Card Number</th><th>Date</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>
  <script>
    // ...existing code from <script> in admin.html...
    // Load all deposits for admin
    async function loadDeposits() {
      const notice = document.getElementById('depositsNotice');
      const table = document.getElementById('depositsTable');
      if (!notice || !table) return;
      const tbody = table.querySelector('tbody');
      try {
      const res = await fetch('https://invex-public.onrender.com/api/deposits/all');
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) {
          notice.textContent = 'No deposits found.';
          table.style.display = 'none';
          return;
        }
        notice.style.display = 'none';
        table.style.display = '';
        tbody.innerHTML = data.map(dep => `
          <tr>
            <td>${dep.email}</td>
            <td>$${Number(dep.amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td>${Number(dep.btcAmount).toFixed(8)}</td>
            <td>$${Number(dep.btcPrice).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td>${dep.cardNumber || ''}</td>
            <td>${new Date(dep.createdAt).toLocaleString()}</td>
          </tr>
        `).join('');
      } catch (err) {
        notice.textContent = 'Failed to load deposits: ' + err.message;
        table.style.display = 'none';
      }
    }
    document.addEventListener('DOMContentLoaded', loadDeposits);
    // Show currently logged-in client at the top
    async function showCurrentClient() {
      try {
        const res = await fetch('https://invex-public.onrender.com/api/users/current-client', { credentials: 'include' });
        const user = await res.json();
        const div = document.getElementById('currentClientInfo');
        if (user && user.email) {
          div.style.display = 'block';
          div.textContent = `Logged-in client: ${user.email} (${user.role})`;
        } else {
          div.style.display = 'block';
          div.textContent = 'No client is currently logged in.';
        }
      } catch {
        // ignore
      }
    }
    showCurrentClient();
    // Backend API integration for admin panel

    let users = [];
    let selectedClientEmail = null;
    const clientList = document.getElementById('clientList');

    async function fetchUsers() {
      const res = await fetch('https://invex-public.onrender.com/api/users', {
        credentials: 'include'
      });
      users = await res.json();
      console.log('Fetched users:', users); // DEBUG: log users to inspect roles
      return users;
    }

    async function syncUsersAndList() {
      await fetchUsers();
      clientList.innerHTML = '';
      if (users.length === 0) {
        clientList.innerHTML = '<span style="color:#f55;font-weight:700;">No clients found. Register users to manage portfolios.</span>';
        document.getElementById('userInfo').innerHTML = '';
        document.getElementById('portfolioSummary').textContent = '';
        document.querySelector('#holdings tbody').innerHTML = '';
        selectedClientEmail = null;
        return false;
      }
      users.forEach(user => {
        const card = document.createElement('div');
        card.className = 'client-card';
        card.style = `
          background: ${selectedClientEmail===user.email?'#1565ff33':'#232a3b'};
          border-radius: 14px;
          padding: 18px 24px;
          margin-bottom: 10px;
          width: 100%;
          box-shadow: 0 2px 12px #1565ff22;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 18px;
          border: 2.5px solid ${selectedClientEmail===user.email?'#1565ff':'#232a3b'};
          transition: border 0.2s, background 0.2s;
        `;
        card.onmouseover = function() {
          card.style.background = '#1565ff22';
        };
        card.onmouseout = function() {
          card.style.background = selectedClientEmail===user.email ? '#1565ff33' : '#232a3b';
        };
        card.onclick = function() {
          selectedClientEmail = user.email;
          renderPortfolio();
        };
        card.innerHTML = `
          <div style="background:#1565ff22;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;">
            <svg width="24" height="24" fill="#1565ff" viewBox="0 0 24 24"><path d="M12 12c2.7 0 4.5-1.8 4.5-4.5S14.7 3 12 3 7.5 4.8 7.5 7.5 9.3 12 12 12zm0 2c-3 0-9 1.5-9 4.5V21h18v-2.5c0-3-6-4.5-9-4.5z"/></svg>
          </div>
          <div style="flex:1;">
            <div style="font-size:1.18rem;font-weight:700;color:#fff;">${user.name || '-'} <span style="color:#1565ff;font-size:1rem;font-weight:600;">(${user.role || 'client'})</span></div>
            <div style="font-size:1rem;color:#bbb;">${user.email}</div>
          </div>
          <div style="font-size:0.95rem;color:#fff;font-weight:700;">${selectedClientEmail===user.email ? '✓ Selected' : ''}</div>
        `;
        clientList.appendChild(card);
      });
      // Auto-select first client if none selected
      if (!selectedClientEmail && users.length) {
        selectedClientEmail = users[0].email;
      }
      return true;
    }

    async function fetchPortfolio(email) {
      const res = await fetch(`https://invex-public.onrender.com/api/portfolios/${email}`, {
        credentials: 'include'
      });
      return await res.json();
    }

    async function renderPortfolio() {
      const hasClients = await syncUsersAndList();
      if (!hasClients || !selectedClientEmail) {
        return;
      }
      Array.from(clientList.children).forEach(card => {
        if (card.classList.contains('client-card')) {
          card.style.border = card.textContent.includes(selectedClientEmail) ? '2px solid #1565ff' : '2px solid #232a3b';
        }
      });
      const email = selectedClientEmail;
      const user = users.find(u => u.email === email);
      const userInfoDiv = document.getElementById('userInfo');
      if (user) {
        userInfoDiv.innerHTML = `
          <div style="background:#1565ff22;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;">
            <svg width="24" height="24" fill="#1565ff" viewBox="0 0 24 24"><path d="M12 12c2.7 0 4.5-1.8 4.5-4.5S14.7 3 12 3 7.5 4.8 7.5 7.5 9.3 12 12 12zm0 2c-3 0-9 1.5-9 4.5V21h18v-2.5c0-3-6-4.5-9-4.5z"/></svg>
          </div>
          <div style="flex:1;">
            <div style="font-size:1.12rem;font-weight:700;color:#fff;margin-bottom:2px;">${user.name || '-'} <span style="color:#1565ff;font-size:0.98rem;font-weight:600;">(${user.role || 'client'})</span></div>
            <div style="font-size:0.98rem;color:#bbb;margin-bottom:2px;"><strong>Email:</strong> ${user.email}</div>
            <div style="font-size:0.98rem;color:#bbb;"><strong>Last Login:</strong> ${user.lastLogin || '-'}</div>
          </div>
        `;
      } else {
        userInfoDiv.innerHTML = '<span style="color:#f55;font-weight:700;">User not found.</span>';
      }

      // Portfolio logic
      const pfSummary = document.getElementById('portfolioSummary');
      const tbody = document.querySelector('#holdings tbody');
      tbody.innerHTML = '';
      let portfolio = await fetchPortfolio(email);
      const assets = Array.isArray(portfolio.assets) ? portfolio.assets : [];
      if (!assets.length) {
        pfSummary.textContent = 'Total Portfolio Value: $0.00';
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">No assets found for this client.</td></tr>';
        return;
      }
      let totalValue = 0;
      assets.forEach(it => {
        const price = Number(it.avgPrice || 0);
        const amt = Number(it.amount || 0);
        const value = price * amt;
        totalValue += value;
        tbody.innerHTML += `<tr>
          <td>${(it.symbol || "").toUpperCase()}</td>
          <td>${amt.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td>${price ? "$" + price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "—"}</td>
          <td>${price ? "$" + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "—"}</td>
          <td><button class="edit-btn" onclick="editAsset('${it.symbol}','${email}')">Edit</button></td>
        `;
      });
      pfSummary.textContent = `Total Portfolio Value: $${totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // Coin logo selection logic
    let selectedCoin = null;
    document.addEventListener('DOMContentLoaded', function() {
      const coinLogos = document.querySelectorAll('.coin-logo');
      const selectedCoinLabel = document.getElementById('selectedCoinLabel');
      coinLogos.forEach(logo => {
        logo.onclick = async function() {
          coinLogos.forEach(l => l.style.border = '2px solid #232a3b');
          logo.style.border = '2.5px solid #1565ff';
          selectedCoin = logo.getAttribute('data-symbol');
          selectedCoinLabel.textContent = 'Selected: ' + selectedCoin;
          // Fetch live price from CoinGecko
          let price = await fetchLivePrice(selectedCoin);
          document.getElementById('newAvgPrice').value = price !== null ? price : '';
        };
      });
    });

    async function fetchLivePrice(symbol) {
      // Map symbol to CoinGecko id
      const coinMap = {
        BTC: 'bitcoin',
        ETH: 'ethereum',
        ADA: 'cardano',
        BNB: 'binancecoin'
      };
      const id = coinMap[symbol];
      if (!id) return null;
      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`);
        const data = await res.json();
        return data[id]?.usd ?? null;
      } catch (err) {
        return null;
      }
    }

    window.addAsset = async function() {
      const email = selectedClientEmail;
      if (!email) return alert('Select a client first');
      const symbol = selectedCoin;
      const quantityInput = document.getElementById('newAmount').value;
      const avgPriceInput = document.getElementById('newAvgPrice').value;
      if (!symbol) return alert('Select a coin');
      let quantity = parseFloat(quantityInput);
      let avgPrice = parseFloat(avgPriceInput);
      if (!quantityInput || isNaN(quantity)) quantity = 0;
      if (!avgPriceInput || isNaN(avgPrice)) avgPrice = 0;
      try {
        const res = await fetch(`https://invex-public.onrender.com/api/portfolios/${email}/assets`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ symbol, amount: quantity, avgPrice })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to add asset');
        await renderPortfolio();
        // Show confirmation to admin with calculated value
        const value = (quantity * avgPrice).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        alert(`Successfully added ${quantity} ${symbol} at $${avgPrice} to ${email}'s portfolio. Value: $${value}`);
        selectedCoin = null;
        document.getElementById('selectedCoinLabel').textContent = '';
        document.getElementById('newAmount').value = '';
        document.getElementById('newAvgPrice').value = '';
        document.querySelectorAll('.coin-logo').forEach(l => l.style.border = '2px solid #232a3b');
      } catch (err) {
        alert('Failed to add asset: ' + err.message);
      }
    }

window.editAsset = async function(symbol, email) {
  if (!email) return alert('Select a client first');
  let portfolio = await fetchPortfolio(email);
  const asset = portfolio.assets.find(it => it.symbol === symbol);
  const currentAmount = asset ? asset.amount : 0;
  // Prompt for new amount only
  const newAmount = prompt(`Set new amount for ${symbol}:`, currentAmount);
  if (newAmount === null) return; // Cancelled
  const amount = Number(newAmount);
  if (isNaN(amount) || amount <= 0) return alert('Enter a valid number');
  // Fetch live price from CoinGecko
  let livePrice = null;
  try {
    livePrice = await fetchLivePrice(symbol);
  } catch {}
  if (!livePrice) return alert('Could not fetch live price for ' + symbol);
  // Use live price as avg price
  const avgPrice = livePrice;
  if (!confirm(`Average price will be set to the current live price: $${avgPrice.toFixed(2)}. Save this value?`)) return;
  try {
    const res = await fetch(`https://invex-public.onrender.com/api/portfolios/${email}/assets/${symbol}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ amount: amount, avgPrice: avgPrice })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed to update asset');
    await renderPortfolio();
  } catch (err) {
    alert('Failed to update asset: ' + err.message);
  }
}

    window.addEventListener('DOMContentLoaded', renderPortfolio);
  </script>
</body>
</html>
